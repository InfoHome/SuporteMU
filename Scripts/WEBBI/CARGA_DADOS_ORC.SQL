DROP PROCEDURE CARGA_BI_ORC
GO


CREATE PROCEDURE CARGA_BI_ORC
AS
BEGIN

BEGIN TRANSACTION
TRUNCATE TABLE NIVEL11_ORC
TRUNCATE TABLE NIVEL10_ORC
TRUNCATE TABLE NIVEL9_ORC
TRUNCATE TABLE NIVEL8_ORC
TRUNCATE TABLE NIVEL7_ORC
TRUNCATE TABLE NIVEL6_ORC
TRUNCATE TABLE NIVEL5_ORC
TRUNCATE TABLE NIVEL4_ORC
TRUNCATE TABLE NIVEL3_ORC
TRUNCATE TABLE NIVEL2_ORC
TRUNCATE TABLE NIVEL1_ORC
TRUNCATE TABLE TAB_NIVEL11_ORC
TRUNCATE TABLE TAB_NIVEL10_ORC
TRUNCATE TABLE TAB_NIVEL9_ORC
TRUNCATE TABLE TAB_NIVEL8_ORC
TRUNCATE TABLE TAB_NIVEL7_ORC
TRUNCATE TABLE TAB_NIVEL6_ORC
TRUNCATE TABLE TAB_NIVEL5_ORC
TRUNCATE TABLE TAB_NIVEL4_ORC
TRUNCATE TABLE TAB_NIVEL3_ORC
TRUNCATE TABLE TAB_NIVEL2_ORC
TRUNCATE TABLE TAB_NIVEL1_ORC
COMMIT


BEGIN TRANSACTION
/* --- VENDAS  - ORCAMENTO FATURADO
*/
INSERT INTO NIVEL11_ORC
SELECT  PED.NUMPED,
         --SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103),4,2) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,1,2),
         SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103),4,2) + SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103) ,1,2),
         PED.FILIAL,
         RIGHT('00000' + LTRIM(RTRIM( PED.CODVEND )),5),
         SUBSTRING(PED.CIDADCLI,1,40),
         RIGHT('0000000000' + LTRIM(RTRIM(PED.CODCLIE)),10),
         RIGHT('0000000000' + LTRIM(RTRIM(PROD.CODFOR)),10),
		 SUBSTRING(PROD.CLASPROD,1,2),
		 SUBSTRING(PROD.CLASPROD,1,5),
		 SUBSTRING(PROD.CLASPROD,1,8),
         RIGHT('00000' + LTRIM(RTRIM( ITPD.CODPRO )),5),
         CONVERT(DATETIME,CONVERT(CHAR,VEN.DTVEN,103),103) ,
         '1',
         0, --VALOR ORC
         0, --CUSTO ORC
         SUM((ITPD.PRECO*ITPD.QUANT*( 1 + (PED.FRETEORC - PED.DESCONTO)/(PED.VALPED + PED.DESCONTO-PED.FRETEORC)))+ITPD.VALORIPI + COMP.VALORSUBSTRIBUTARIA),  --VALOR VENDA
         SUM(ITPD.PRECOCOMP*ITPD.QUANT)  --CUSTO VENDA
           
FROM  BDENTER.DBO.VENDASSCAD VEN,
	  BDENTER.DBO.PEDICLICAD PED, 
	  BDENTER.DBO.ITEMCLICAD ITPD, 
	  BDENTER.DBO.PRODUTOCAD PROD, 
	  BDENTER.DBO.ITEMCLICOMPLEMENTO COMP
	  
WHERE  VEN.NUMPED > 7 
	   AND VEN.NUMPED = PED.NUMPED  
	   AND PED.NUMPED = ITPD.NUMPED 
       AND PROD.CODPRO = ITPD.CODPRO  
       AND COMP.NUMPED = ITPD.NUMPED 
       AND COMP.RITEM = ITPD.ITEM 
       AND (PED.VALPED + PED.DESCONTO-PED.FRETEORC) > 0 
       AND PED.SITVEN='2'  
       AND ITPD.SITFAT IN ('0','1')
       -- PEGAR APENAS TPOS QUE INTEGRAM COM O FATURAMENTO
       AND PED.TPO IN (SELECT HIERARQUIANUMERO FROM BDENTER..TPO_R WHERE OID IN (SELECT RTPO FROM BDENTER..TPOINTERFERENCIA WHERE RTPOINTEGRACAO=16100 AND VALOR='S') AND HIERARQUIANUMERO LIKE'2%')
	   AND PED.TPO <>'20104'
	   AND PED.VALPED > 0
	   
GROUP BY PED.NUMPED,
         --SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103),4,2) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,1,2),
         SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103),4,2) + SUBSTRING(CONVERT(VARCHAR,VEN.DTVEN,103) ,1,2),
         PED.FILIAL,
         RIGHT('00000' + LTRIM(RTRIM( PED.CODVEND )),5),
         SUBSTRING(PED.CIDADCLI,1,40),
         RIGHT('0000000000' + LTRIM(RTRIM(PED.CODCLIE)),10),
         RIGHT('0000000000' + LTRIM(RTRIM(PROD.CODFOR)),10),
         SUBSTRING(PROD.CLASPROD,1,2),
		 SUBSTRING(PROD.CLASPROD,1,5),
		 SUBSTRING(PROD.CLASPROD,1,8),
        RIGHT('00000' + LTRIM(RTRIM( ITPD.CODPRO )),5),
         CONVERT(DATETIME,CONVERT(CHAR,VEN.DTVEN,103),103)
COMMIT
--================================================================================================================
--TODOS OS ORCAMENTOS
BEGIN TRANSACTION
INSERT INTO NIVEL11_ORC
SELECT  PED.NUMPED,
         SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103),4,2) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,1,2),
         PED.FILIAL,
         RIGHT('00000' + LTRIM(RTRIM( PED.CODVEND )),5),
         SUBSTRING(PED.CIDADCLI,1,40),
         RIGHT('0000000000' + LTRIM(RTRIM(PED.CODCLIE)),10),
         RIGHT('0000000000' + LTRIM(RTRIM(PROD.CODFOR)),10),
		 SUBSTRING(PROD.CLASPROD,1,2),
		 SUBSTRING(PROD.CLASPROD,1,5),
		 SUBSTRING(PROD.CLASPROD,1,8),
         RIGHT('00000' + LTRIM(RTRIM( ITPD.CODPRO )),5),
         CONVERT(DATETIME,CONVERT(CHAR,PED.DTPEDIDO,103),103) ,
         '2',
         SUM(ITPD.PRECO * ITPD.QUANT*( 1 + (PED.FRETEORC - PED.DESCONTO)/(PED.VALPED + PED.DESCONTO-PED.FRETEORC))), --VALOR ORC
         SUM(ITPD.PRECOCOMP * ITPD.QUANT), --CUSTO ORC
         0,--VALOR VENDA
         0--CUSTO VENDA
            
FROM  BDENTER.DBO.PEDICLICAD PED, 
	  BDENTER.DBO.ITEMCLICAD ITPD, 
	  BDENTER.DBO.PRODUTOCAD PROD
	  
WHERE   
	   PED.NUMPED = ITPD.NUMPED 
	   AND ITPD.CODPRO = PROD.CODPRO 
      -- PEGAR APENAS TPOS QUE INTEGRAM COM O FATURAMENTO
       --AND PED.TPO IN (SELECT HIERARQUIANUMERO FROM BDENTER..TPO_R WHERE OID IN (SELECT RTPO FROM BDENTER..TPOINTERFERENCIA WHERE RTPOINTEGRACAO=16100 AND VALOR='S') AND HIERARQUIANUMERO LIKE'2%')
	   AND PED.TPO <>'20104'
	   AND PED.VALPED > 0
	   
GROUP BY PED.NUMPED,
         --SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103),4,2) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,1,2),
         SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103),4,2) + SUBSTRING(CONVERT(VARCHAR,PED.DTPEDIDO,103) ,1,2),
         PED.FILIAL,
         RIGHT('00000' + LTRIM(RTRIM( PED.CODVEND )),5),
         SUBSTRING(PED.CIDADCLI,1,40),
         RIGHT('0000000000' + LTRIM(RTRIM(PED.CODCLIE)),10),
         RIGHT('0000000000' + LTRIM(RTRIM(PROD.CODFOR)),10),
         SUBSTRING(PROD.CLASPROD,1,2),
		 SUBSTRING(PROD.CLASPROD,1,5),
		 SUBSTRING(PROD.CLASPROD,1,8),
        RIGHT('00000' + LTRIM(RTRIM( ITPD.CODPRO )),5),
         CONVERT(DATETIME,CONVERT(CHAR,PED.DTPEDIDO,103),103)
COMMIT



--================================================================================================================
BEGIN TRANSACTION
INSERT INTO NIVEL10_ORC SELECT NIVEL10, NIVEL1, NIVEL2, NIVEL3,NIVEL4, NIVEL5,NIVEL6,NIVEL7,NIVEL8,NIVEL9,DATA, SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL11_ORC
                      GROUP BY NIVEL10, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,NIVEL6, NIVEL7,NIVEL8,NIVEL9,DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL9_ORC SELECT NIVEL9, NIVEL1, NIVEL2, NIVEL3,NIVEL4, NIVEL5,NIVEL6,NIVEL7,NIVEL8,DATA, SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL10_ORC
                      GROUP BY NIVEL9, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,NIVEL6, NIVEL7,NIVEL8,DATA;
COMMIT


BEGIN TRANSACTION
INSERT INTO NIVEL8_ORC SELECT NIVEL8, NIVEL1, NIVEL2, NIVEL3,NIVEL4, NIVEL5,NIVEL6,NIVEL7,DATA, SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL9_ORC
                      GROUP BY NIVEL8, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,NIVEL6, NIVEL7,DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL7_ORC SELECT NIVEL7, NIVEL1, NIVEL2, NIVEL3,NIVEL4, NIVEL5,NIVEL6,DATA, SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL8_ORC
                      GROUP BY NIVEL7, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,NIVEL6, DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL6_ORC SELECT NIVEL6, NIVEL1, NIVEL2, NIVEL3,NIVEL4,NIVEL5,DATA,  SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL7_ORC
                      GROUP BY NIVEL6, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL5_ORC SELECT NIVEL5, NIVEL1, NIVEL2, NIVEL3,NIVEL4,DATA,  SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL6_ORC
                      GROUP BY NIVEL5, NIVEL1, NIVEL2, NIVEL3, NIVEL4, DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL4_ORC SELECT NIVEL4, NIVEL1, NIVEL2, NIVEL3,DATA, SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL5_ORC
                      GROUP BY NIVEL4, NIVEL1, NIVEL2, NIVEL3, DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL3_ORC SELECT NIVEL3, NIVEL1, NIVEL2, DATA,  SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL4_ORC
                      GROUP BY NIVEL3, NIVEL1, NIVEL2, DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL2_ORC SELECT NIVEL2, NIVEL1, DATA,  SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL3_ORC
                      GROUP BY NIVEL2, NIVEL1, DATA;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL1_ORC SELECT NIVEL1, DATA,  SUM( ATR1 ),
                          SUM( ATR2 ), SUM( ATR3 ), SUM( ATR4 )
                      FROM NIVEL2_ORC
                      GROUP BY NIVEL1, DATA;
COMMIT
--================================================================================================

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL1_ORC (NIVEL1, DESCRICAO) SELECT DISTINCT NIVEL1, SUBSTRING(NIVEL1,7,2)+'/'+SUBSTRING(NIVEL1,5,2)+'/'+SUBSTRING(NIVEL1,1,4)
                          FROM NIVEL1_ORC
                          WHERE NOT EXISTS (SELECT NIVEL1 FROM TAB_NIVEL1_ORC WHERE
                          TAB_NIVEL1_ORC.NIVEL1=NIVEL1_ORC.NIVEL1)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL2_ORC (NIVEL2, DESCRICAO) SELECT DISTINCT NIVEL2, 'FILIAL ' + NIVEL2
                          FROM NIVEL2_ORC
                          WHERE NOT EXISTS (SELECT NIVEL2 FROM TAB_NIVEL2_ORC WHERE
                          TAB_NIVEL2_ORC.NIVEL2=NIVEL2_ORC.NIVEL2)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL3_ORC (NIVEL3, DESCRICAO) SELECT DISTINCT NIVEL3, 'VENDEDOR ' + NIVEL3
                          FROM NIVEL3_ORC
                          WHERE NOT EXISTS (SELECT NIVEL3 FROM TAB_NIVEL3_ORC WHERE
                          TAB_NIVEL3_ORC.NIVEL3=NIVEL3_ORC.NIVEL3)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL4_ORC (NIVEL4, DESCRICAO) SELECT DISTINCT NIVEL4, NIVEL4
                          FROM NIVEL4_ORC
                          WHERE NOT EXISTS (SELECT NIVEL4 FROM TAB_NIVEL4_ORC WHERE
                          TAB_NIVEL4_ORC.NIVEL4=NIVEL4_ORC.NIVEL4)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL5_ORC (NIVEL5, DESCRICAO) SELECT DISTINCT NIVEL5,  'CLIENTE' + NIVEL5
                          FROM NIVEL5_ORC
                          WHERE NOT EXISTS (SELECT NIVEL5 FROM TAB_NIVEL5_ORC WHERE
                          TAB_NIVEL5_ORC.NIVEL5 = NIVEL5_ORC.NIVEL5)
COMMIT


BEGIN TRANSACTION
INSERT INTO TAB_NIVEL6_ORC (NIVEL6, DESCRICAO) SELECT DISTINCT NIVEL6, 'FORNECEDOR' + NIVEL6
                          FROM NIVEL6_ORC
                          WHERE NOT EXISTS (SELECT NIVEL6 FROM TAB_NIVEL6_ORC WHERE
                          TAB_NIVEL6_ORC.NIVEL6 = NIVEL6_ORC.NIVEL6)
COMMIT
--===================================================================================================
BEGIN TRANSACTION
INSERT INTO TAB_NIVEL7_ORC (NIVEL7, DESCRICAO) SELECT DISTINCT NIVEL7, 'CLASSE N1 ' + NIVEL7
                          FROM NIVEL7_ORC
                          WHERE NOT EXISTS (SELECT NIVEL7 FROM TAB_NIVEL7_ORC WHERE
                          TAB_NIVEL7_ORC.NIVEL7=NIVEL7_ORC.NIVEL7)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL8_ORC (NIVEL8, DESCRICAO) SELECT DISTINCT NIVEL8, 'CLASSE N2 ' + NIVEL8
                          FROM NIVEL8_ORC
                          WHERE NOT EXISTS (SELECT NIVEL8 FROM TAB_NIVEL8_ORC WHERE
                          TAB_NIVEL8_ORC.NIVEL8=NIVEL8_ORC.NIVEL8)
COMMIT

--===================================================================================================
BEGIN TRANSACTION
INSERT INTO TAB_NIVEL9_ORC (NIVEL9, DESCRICAO) SELECT DISTINCT NIVEL9, 'CLASSE N3 ' + NIVEL9
                          FROM NIVEL9_ORC
                          WHERE NOT EXISTS (SELECT NIVEL9 FROM TAB_NIVEL9_ORC WHERE
                          TAB_NIVEL9_ORC.NIVEL9=NIVEL9_ORC.NIVEL9)
COMMIT
--==================================================================================================
BEGIN TRANSACTION
INSERT INTO TAB_NIVEL10_ORC (NIVEL10, DESCRICAO) SELECT DISTINCT NIVEL10, 'PRODUTO ' + NIVEL10
                          FROM NIVEL10_ORC
                          WHERE NOT EXISTS (SELECT NIVEL10 FROM TAB_NIVEL10_ORC WHERE
                          TAB_NIVEL10_ORC.NIVEL10 = NIVEL10_ORC.NIVEL10)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL11_ORC (NIVEL11, DESCRICAO) SELECT DISTINCT NIVEL11, 'PEDIDO ' + NIVEL11
                          FROM NIVEL11_ORC
                          WHERE NOT EXISTS (SELECT NIVEL11 FROM TAB_NIVEL11_ORC WHERE
                          TAB_NIVEL11_ORC.NIVEL11 = NIVEL11_ORC.NIVEL11)
COMMIT

--====================================================================================================
BEGIN TRANSACTION
UPDATE TAB_NIVEL1_ORC SET MES      = SUBSTRING ( NIVEL1,5,2) + '/' + LEFT(NIVEL1,4),
		      BIMESTRE = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '05' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '05' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '06' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '06' +  '/' + LEFT(NIVEL1,4)
			END,
		      TRIMESTRE = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '04' +  '/' + LEFT(NIVEL1,4)
			END,
		      QUADRIMESTRE  = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '03' +  '/' + LEFT(NIVEL1,4)
			END,
		      SEMESTRE  = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '02' +  '/' + LEFT(NIVEL1,4)
			END,
			ANO = LEFT(NIVEL1,4),
		      DIAUTIL  = CASE DATEPART(DW,CONVERT(DATETIME,NIVEL1)) 
                      WHEN '1' THEN 'N'
                      WHEN '2' THEN 'S' 
                      WHEN '3' THEN 'S' 
                      WHEN '4' THEN 'S' 
                      WHEN '5' THEN 'S' 
                      WHEN '6' THEN 'S' 
                      WHEN '7' THEN 'N' 
			END
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL2_ORC SET DESCRICAO =  UPPER(NOME)
           FROM TAB_NIVEL2_ORC, BDENTER.DBO.FILIALCAD
           WHERE NIVEL2 = FILIAL
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL3_ORC SET DESCRICAO =  UPPER(V.NOME), 
                      GERENTE = V.CODGER
           FROM TAB_NIVEL3_ORC, BDENTER.DBO.VENDEDOCAD V
           WHERE NIVEL3 = RIGHT('00000' + LTRIM(RTRIM( V.CODVEND )),5)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL3_ORC SET GERENTE = V.NOME
           FROM TAB_NIVEL3_ORC, BDENTER.DBO.VENDEDOCAD V
           WHERE GERENTE =  V.CODVEND
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL5_ORC SET DESCRICAO =  UPPER(NOME)
           FROM TAB_NIVEL5_ORC, BDENTER.DBO.ITEM
           WHERE NIVEL5 = RIGHT('0000000000' + LTRIM(RTRIM( OID )),10)
COMMIT


BEGIN TRANSACTION
UPDATE TAB_NIVEL6_ORC SET DESCRICAO =  UPPER(NOME)
           FROM TAB_NIVEL6_ORC, BDENTER.DBO.ITEM
           WHERE NIVEL6 = RIGHT('0000000000' + LTRIM(RTRIM( OID )),10)
COMMIT
--=================================================================== CLASSE N1
BEGIN TRANSACTION
UPDATE TAB_NIVEL7_ORC SET DESCRICAO =  SUBSTRING(C.CLASPROD,1,2)+' - '+ LEFT(UPPER(C.DESCR),80)
           FROM TAB_NIVEL7_ORC, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL7 = SUBSTRING(C.CLASPROD,1,2)
COMMIT


BEGIN TRANSACTION
UPDATE TAB_NIVEL8_ORC SET DESCRICAO =  SUBSTRING(C.CLASPROD,1,5)+' - '+ LEFT(UPPER(C.DESCR),80)
           FROM TAB_NIVEL8_ORC, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL8 = SUBSTRING(C.CLASPROD,1,5)
COMMIT


BEGIN TRANSACTION
UPDATE TAB_NIVEL9_ORC SET DESCRICAO =  SUBSTRING(C.CLASPROD,1,8)+' - '+ LEFT(UPPER(C.DESCR),80)
           FROM TAB_NIVEL9_ORC, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL9 = SUBSTRING(C.CLASPROD,1,8)
COMMIT
--===================================================================

BEGIN TRANSACTION
UPDATE TAB_NIVEL10_ORC SET DESCRICAO = P.CODPRO+'-'+LEFT(UPPER(C.DESCRICAOLONGA),80),
                          FORNECEDOR = RIGHT('0000000000' + LTRIM(RTRIM( P.CODFOR )),10),
                          COMPRADOR = P.COMPRADOR
           FROM TAB_NIVEL10_ORC, BDENTER.DBO.PRODUTOCAD P, BDENTER.DBO.COMPLEMENTOPRODUTO C
           WHERE NIVEL10 = RIGHT('00000' + LTRIM(RTRIM( P.CODPRO )),5) AND P.CODPRO=C.CODPRO
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL10_ORC SET FORNECEDOR = UPPER(SUBSTRING(NOME,1,50))
           FROM TAB_NIVEL10_ORC, BDENTER.DBO.ITEM
           WHERE FORNECEDOR = RIGHT('0000000000' + LTRIM(RTRIM( OID )),10)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL10_ORC SET COMPRADOR = UPPER(NOME)
           FROM TAB_NIVEL10_ORC, BDENTER.DBO.COMPRADCAD
           WHERE COMPRADOR = CODCOMP
 
COMMIT          
--====================================================================
BEGIN TRANSACTION
UPDATE TAB_NIVEL11_ORC SET DESCRICAO = UPPER(NUMPED)
           FROM TAB_NIVEL11_ORC, BDENTER.DBO.PEDICLICAD
           WHERE NIVEL11 = NUMPED
COMMIT

BEGIN TRANSACTION
UPDATE TAB_PARAMETROS_ORC SET ATUALIZADOEM = GETDATE();
COMMIT

END