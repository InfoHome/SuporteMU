DROP PROCEDURE CARGA_BI_COMPRAS
GO

DROP VIEW PRAZOMEDIO
GO

CREATE VIEW PRAZOMEDIO AS SELECT N.NUMORD, SUM(DATEDIFF(DAY,D.EMISSAO,D.VENCIMENTO))/COUNT(D.OID) AS PRAZO
FROM BDENTER.DBO.CONTAAPAGAR_R D, BDENTER.DBO.NFENTRACAD N 
WHERE D.RDOCDEORIGEM = N.OIDDOCDEORIGEM AND 
      N.TPO LIKE '1%' AND N.ATUALIZ = 1
GROUP BY N.NUMORD
GO

CREATE PROCEDURE CARGA_BI_COMPRAS
AS

BEGIN

BEGIN TRANSACTION
TRUNCATE TABLE NIVEL6_COMPRAS
TRUNCATE TABLE NIVEL5_COMPRAS
TRUNCATE TABLE NIVEL4_COMPRAS
TRUNCATE TABLE NIVEL3_COMPRAS
TRUNCATE TABLE NIVEL2_COMPRAS
TRUNCATE TABLE NIVEL1_COMPRAS
TRUNCATE TABLE TAB_NIVEL6_COMPRAS
TRUNCATE TABLE TAB_NIVEL5_COMPRAS
TRUNCATE TABLE TAB_NIVEL4_COMPRAS
TRUNCATE TABLE TAB_NIVEL3_COMPRAS
TRUNCATE TABLE TAB_NIVEL2_COMPRAS
TRUNCATE TABLE TAB_NIVEL1_COMPRAS
COMMIT



BEGIN TRANSACTION
/* --- COMPRAS */
INSERT INTO NIVEL7_COMPRAS
SELECT   RIGHT('00000' + LTRIM(RTRIM( ITNE.CODPRO )),5),
         SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103),4,2) + SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103) ,1,2),
         NE.FILIAL,
         RIGHT('0000000000' + LTRIM(RTRIM( NE.CODFOR )),10),
         SUBSTRING(PROD.CLASPROD,1,2),
         SUBSTRING(PROD.CLASPROD,1,5),
         SUBSTRING(PROD.CLASPROD,1,8),
         CONVERT(DATETIME,CONVERT(CHAR,NE.DTCHEG,103),103) ,
         '1',
         SUM( ITNE.QUANT),
         SUM((ITNE.PRECOTOTAL+ITNE.VALORIPI+ITNE.VALSUBSTRI)+ ( ( (ITNE.PRECOTOTAL+ITNE.VALORIPI+ITNE.VALSUBSTRI)/(NE.VALCONTAB-NE.VALFRETE-NE.DESPINCL) )* (NE.VALFRETE+NE.DESPINCL))),
		 SUM((ITNE.PRECOTOTAL+ITNE.VALORIPI+ITNE.VALSUBSTRI+ITCOM.VALTRIBANTECIPADA)+ ( ( (ITNE.PRECOTOTAL+ITNE.VALORIPI+ITNE.VALSUBSTRI)/(NE.VALCONTAB-NE.VALFRETE-NE.DESPINCL) )* (NE.VALFRETE+NE.DESPINCL+NE.DESPNINCL))),
         SUM(PM.PRAZO),
         COUNT(ITNE.CODPRO),0
         
FROM   BDENTER.DBO.NFENTRACAD NE,
       BDENTER.DBO.ITNFENTCAD ITNE,  PRAZOMEDIO PM, 
       BDENTER.DBO.PRODUTOCAD PROD,
       BDENTER.DBO.ITNFENTCOMPLEMENTO ITCOM
       
WHERE  NE.NUMORD = ITNE.NUMORD 
	   AND NE.ATUALIZ = 1 
	   AND NE.TPO LIKE '1%' 
       AND ITNE.CODPRO = PROD.CODPRO 
       AND NE.NUMORD = PM.NUMORD 
       AND(NE.VALCONTAB - (NE.DESPINCL+NE.VALFRETE + NE.VALSUBSTRI)) > 0 
       AND(ITNE.NUMORD = ITCOM.NUMORD AND ITNE.ITEM=ITCOM.ITEM) 
       
GROUP BY RIGHT('00000' + LTRIM(RTRIM( ITNE.CODPRO )),5),
         SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103) ,7,4) + SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103),4,2) + SUBSTRING(CONVERT(VARCHAR,NE.DTCHEG,103) ,1,2),
         NE.FILIAL,
         RIGHT('0000000000' + LTRIM(RTRIM( NE.CODFOR )),10),
         SUBSTRING(PROD.CLASPROD,1,2),
         SUBSTRING(PROD.CLASPROD,1,5),
         SUBSTRING(PROD.CLASPROD,1,8),
         CONVERT(DATETIME,CONVERT(CHAR,NE.DTCHEG,103),103)
COMMIT

--================================
BEGIN TRANSACTION
INSERT INTO NIVEL6_COMPRAS SELECT NIVEL6, NIVEL1, NIVEL2, NIVEL3, NIVEL4, NIVEL5,DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL7_COMPRAS
                      GROUP BY NIVEL6, NIVEL1, NIVEL2, NIVEL3,NIVEL4, NIVEL5, DATA ;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL5_COMPRAS SELECT NIVEL5, NIVEL1, NIVEL2, NIVEL3, NIVEL4, DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL6_COMPRAS
                      GROUP BY NIVEL5, NIVEL1, NIVEL2, NIVEL3,NIVEL4, DATA ;
COMMIT


BEGIN TRANSACTION
INSERT INTO NIVEL4_COMPRAS SELECT NIVEL4, NIVEL1, NIVEL2, NIVEL3,DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL5_COMPRAS
                      GROUP BY NIVEL4, NIVEL1, NIVEL2, NIVEL3, DATA ;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL3_COMPRAS SELECT NIVEL3, NIVEL1, NIVEL2, DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL4_COMPRAS
                      GROUP BY NIVEL3, NIVEL1, NIVEL2, DATA ;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL2_COMPRAS SELECT NIVEL2, NIVEL1, DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL3_COMPRAS
                      GROUP BY NIVEL2, NIVEL1, DATA ;
COMMIT

BEGIN TRANSACTION
INSERT INTO NIVEL1_COMPRAS SELECT NIVEL1, DATA , SUM( ATR1 ),
                          SUM( ATR2 ), SUM (ATR3), SUM( ATR4 ), SUM( ATR5 ), SUM( ATR6 )
                      FROM NIVEL2_COMPRAS
                      GROUP BY NIVEL1, DATA ;
COMMIT

--===================================================================================================
BEGIN TRANSACTION
INSERT INTO TAB_NIVEL1_COMPRAS (NIVEL1, DESCRICAO) SELECT DISTINCT NIVEL1, 
                          SUBSTRING(NIVEL1,7,2)+'/'+SUBSTRING(NIVEL1,5,2)+'/'+
                          SUBSTRING(NIVEL1,1,4)
                          FROM NIVEL1_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL1 FROM TAB_NIVEL1_COMPRAS WHERE
                          TAB_NIVEL1_COMPRAS.NIVEL1=NIVEL1_COMPRAS.NIVEL1)
COMMIT


BEGIN TRANSACTION
INSERT INTO TAB_NIVEL2_COMPRAS (NIVEL2, DESCRICAO) SELECT DISTINCT NIVEL2, 'FILIAL ' + NIVEL2
                          FROM NIVEL2_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL2 FROM TAB_NIVEL2_COMPRAS WHERE
                          TAB_NIVEL2_COMPRAS.NIVEL2=NIVEL2_COMPRAS.NIVEL2)
COMMIT


BEGIN TRANSACTION
INSERT INTO TAB_NIVEL3_COMPRAS (NIVEL3, DESCRICAO) SELECT DISTINCT NIVEL3, 'FORNECEDOR' + NIVEL3
                          FROM NIVEL3_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL3 FROM TAB_NIVEL3_COMPRAS WHERE
                          TAB_NIVEL3_COMPRAS.NIVEL3=NIVEL3_COMPRAS.NIVEL3)
COMMIT


BEGIN TRANSACTION
INSERT INTO TAB_NIVEL4_COMPRAS (NIVEL4, DESCRICAO) SELECT DISTINCT NIVEL4, 'CLASSE N1 '+NIVEL4
                          FROM NIVEL4_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL4 FROM TAB_NIVEL4_COMPRAS WHERE
                          TAB_NIVEL4_COMPRAS.NIVEL4=NIVEL4_COMPRAS.NIVEL4)
COMMIT


BEGIN TRANSACTION
INSERT INTO TAB_NIVEL5_COMPRAS (NIVEL5, DESCRICAO) SELECT DISTINCT NIVEL5, 'CLASSE N2 '+NIVEL5
                          FROM NIVEL5_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL5 FROM TAB_NIVEL5_COMPRAS WHERE
                          TAB_NIVEL5_COMPRAS.NIVEL5=NIVEL5_COMPRAS.NIVEL5)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL6_COMPRAS (NIVEL6, DESCRICAO) SELECT DISTINCT NIVEL6, 'CLASSE N3 '+NIVEL6
                          FROM NIVEL6_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL6 FROM TAB_NIVEL6_COMPRAS WHERE
                          TAB_NIVEL6_COMPRAS.NIVEL6=NIVEL6_COMPRAS.NIVEL6)
COMMIT

BEGIN TRANSACTION
INSERT INTO TAB_NIVEL7_COMPRAS (NIVEL7, DESCRICAO) SELECT DISTINCT NIVEL7, 'PRODUTO ' + NIVEL7
                          FROM NIVEL7_COMPRAS
                          WHERE NOT EXISTS (SELECT NIVEL7 FROM TAB_NIVEL7_COMPRAS WHERE
                          TAB_NIVEL7_COMPRAS.NIVEL7=NIVEL7_COMPRAS.NIVEL7)
COMMIT

--======================================================================================================================
BEGIN TRANSACTION
UPDATE TAB_NIVEL1_COMPRAS SET MES      = SUBSTRING ( NIVEL1,5,2) + '/' + LEFT(NIVEL1,4),
		      BIMESTRE = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '05' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '05' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '06' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '06' +  '/' + LEFT(NIVEL1,4)
			END,
		      TRIMESTRE = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '04' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '04' +  '/' + LEFT(NIVEL1,4)
			END,
		      QUADRIMESTRE  = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '03' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '03' +  '/' + LEFT(NIVEL1,4)
			END,
		      SEMESTRE  = CASE SUBSTRING (NIVEL1, 5,2) 
                      WHEN '01' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '02' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '03' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '04' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '05' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '06' THEN '01' +  '/' + LEFT(NIVEL1,4)
                      WHEN '07' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '08' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '09' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '10' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '11' THEN '02' +  '/' + LEFT(NIVEL1,4)
                      WHEN '12' THEN '02' +  '/' + LEFT(NIVEL1,4)
			END,
			ANO = LEFT(NIVEL1,4),
		      DIAUTIL  = CASE DATEPART(DW,CONVERT(DATETIME,NIVEL1)) 
                      WHEN '1' THEN 'N'
                      WHEN '2' THEN 'S' 
                      WHEN '3' THEN 'S' 
                      WHEN '4' THEN 'S' 
                      WHEN '5' THEN 'S' 
                      WHEN '6' THEN 'S' 
                      WHEN '7' THEN 'N' 
			END
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL2_COMPRAS SET DESCRICAO =  UPPER(F.NOME)
           FROM TAB_NIVEL2_COMPRAS, BDENTER.DBO.FILIALCAD F
           WHERE CAST(NIVEL2 AS INT) = CAST(F.FILIAL AS INT)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL3_COMPRAS SET DESCRICAO =  UPPER(CAST (F.NOME AS CHAR(50)))
           FROM TAB_NIVEL3_COMPRAS, BDENTER.DBO.ITEM F
           WHERE CAST(NIVEL3 AS INT) = F.OID
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL4_COMPRAS SET DESCRICAO = SUBSTRING(C.CLASPROD,1,2)+' - ' + LEFT(UPPER(C.DESCR),100)
           FROM TAB_NIVEL4_COMPRAS, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL4 = SUBSTRING(C.CLASPROD,1,2)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL5_COMPRAS SET DESCRICAO = SUBSTRING(C.CLASPROD,1,5)+' - ' + LEFT(UPPER(C.DESCR),100)
           FROM TAB_NIVEL5_COMPRAS, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL5 = SUBSTRING(C.CLASPROD,1,5)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL6_COMPRAS SET DESCRICAO = SUBSTRING(C.CLASPROD,1,8)+' - ' + LEFT(UPPER(C.DESCR),100)
           FROM TAB_NIVEL6_COMPRAS, BDENTER.DBO.CLASSIFCAD C
           WHERE NIVEL6 = SUBSTRING(C.CLASPROD,1,8)
COMMIT
--============================================================================================
BEGIN TRANSACTION
UPDATE TAB_NIVEL7_COMPRAS SET DESCRICAO = UPPER(C.DESCRICAOLONGA),
                          FORN_PROD = RIGHT('0000000000' + LTRIM(RTRIM( P.CODFOR )),10),
                          COMPRADOR = P.COMPRADOR,
                          MODELO = SUBSTRING(P.MODELO,1,50)
           FROM TAB_NIVEL7_COMPRAS, BDENTER.DBO.PRODUTOCAD P, BDENTER.DBO.COMPLEMENTOPRODUTO C
           WHERE CAST(NIVEL7 AS INT) = CAST(P.CODPRO AS INT) AND P.CODPRO = C.CODPRO
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL7_COMPRAS SET FORN_PROD = SUBSTRING(UPPER(NOME),1,50)
           FROM TAB_NIVEL7_COMPRAS, BDENTER.DBO.ITEM
           WHERE FORN_PROD = RIGHT('0000000000' + LTRIM(RTRIM( OID )),10)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_NIVEL7_COMPRAS SET COMPRADOR = UPPER(NOME)
           FROM TAB_NIVEL7_COMPRAS, BDENTER.DBO.COMPRADCAD
           WHERE CAST(COMPRADOR AS INT) = CAST(CODCOMP AS INT)
COMMIT

BEGIN TRANSACTION
UPDATE TAB_PARAMETROS_COMPRAS SET ATUALIZADOEM = GETDATE()
COMMIT


END